<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="layout/main :: layout(~{::section})">

<section>
    <h1 class="mb-4">
        <i class="nav-icon bi bi-list-task me-2"></i>
        Tareas Asignadas
    </h1>

    <div id="alertContainer"></div>

    <a href="/dashboard" class="btn btn-primary mb-3">
        <i class="bi bi-play"></i> Resolver Nuevo Schedule
    </a>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Asignaciones del Último Schedule</h3>
        </div>

        <div class="card-body">
            <table class="table table-striped" id="tasksTable">
                <thead>
                    <tr>
                        <th>Día</th>
                        <th>Tarea</th>
                        <th>Persona Asignada</th>
                    </tr>
                </thead>
                <tbody id="tasksBody">
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            Cargando...
                        </td>
                    </tr>
                </tbody>
            </table>

            <div id="scoreDisplay" class="mt-3 text-end fw-bold"></div>
        </div>
    </div>

    <script>
        async function loadTasks() {
            try {
                const response = await fetch('/api/schedule/last-resolved');

                const tbody = document.getElementById('tasksBody');

                if (response.status === 204) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                No hay schedule resuelto. Ve al Dashboard para resolver uno.
                            </td>
                        </tr>`;
                    return;
                }

                const data = await response.json();
                tbody.innerHTML = '';

                data.assignments.forEach(a => {
                    tbody.insertAdjacentHTML('beforeend', `
                        <tr>
                            <td>${a.day}</td>
                            <td>${a.task}</td>
                            <td>${a.person}</td>
                        </tr>
                    `);
                });

                document.getElementById('scoreDisplay').textContent =
                    `Puntuación: ${data.score ?? 'N/A'}`;

            } catch (e) {
                document.getElementById('tasksBody').innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-danger">
                            Error cargando tareas
                        </td>
                    </tr>`;
            }
        }

        loadTasks();
    </script>

</section>

</html>